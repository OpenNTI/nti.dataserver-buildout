[buildout]
extends = 
    deployment.cfg
    backup_base_environment.cfg

parts +=
    backup-scripts
    log-backup-scripts
    backup-alpha
    backup-janux
    backup-okstate
    backup-outest
    backup-showcase
    logfetch-alpha
    logfetch-janux
    logfetch-mathcounts
    logfetch-okstate
    logfetch-outest
    logfetch-prod
    logfetch-showcase

[boto]
aws_access_key_id = ***REMOVED***
aws_secret_access_key = ${passwords:aws_secret_access_key}

[backupvars]
backup_ssh_key = /home/ntibackup/.ssh/backups
slave_id = 2050

[backup-scripts]
recipe = z3c.recipe.filetemplate
source-directory = templates
dest-directory = ${buildout:root-directory}
files = get_binary_logs backupdb db-backup-config.json my2-backup.cnf my3-backup.cnf my4-backup.cnf my9-backup.cnf my-client.cnf

username = ${backupvars:backup_user}
password = ${passwords:sql_backup_passwd}

[log-backup-scripts]
recipe = z3c.recipe.filetemplate
source-directory = templates
dest-directory = ${buildout:root-directory}
files = logfetch logfetch-config.json gc_logs

[backup-alpha]
recipe = z3c.recipe.usercrontab
times = 0 0 * * *
command = ${deployment:bin-directory}/backupdb -c ${deployment:etc-directory}/db-backup-config.json --temp-dir ${backupvars:backup_cache_dir} --backup-dir ${backupvars:db_backup_dir} -e alpha

[backup-janux]
recipe = z3c.recipe.usercrontab
times = 0 0 * * *
command = ${deployment:bin-directory}/backupdb -c ${deployment:etc-directory}/db-backup-config.json --temp-dir ${backupvars:backup_cache_dir} --backup-dir ${backupvars:db_backup_dir} -e janux

[backup-mathcounts]
recipe = z3c.recipe.usercrontab
times = 0 0 * * *
command = ${deployment:bin-directory}/backupdb -c ${deployment:etc-directory}/db-backup-config.json --temp-dir ${backupvars:backup_cache_dir} --backup-dir ${backupvars:db_backup_dir} -e mc

[backup-okstate]
recipe = z3c.recipe.usercrontab
times = 0 0 * * *
command = ${deployment:bin-directory}/backupdb -c ${deployment:etc-directory}/db-backup-config.json --temp-dir ${backupvars:backup_cache_dir} --backup-dir ${backupvars:db_backup_dir} -e okstate

[backup-outest]
recipe = z3c.recipe.usercrontab
times = 0 0 * * *
command = ${deployment:bin-directory}/backupdb -c ${deployment:etc-directory}/db-backup-config.json --temp-dir ${backupvars:backup_cache_dir} --backup-dir ${backupvars:db_backup_dir} -e outest

[backup-prod]
recipe = z3c.recipe.usercrontab
times = 0 0 * * *
command = ${deployment:bin-directory}/backupdb -c ${deployment:etc-directory}/db-backup-config.json --temp-dir ${backupvars:backup_cache_dir} --backup-dir ${backupvars:db_backup_dir} -e prod

[backup-showcase]
recipe = z3c.recipe.usercrontab
times = 0 0 * * *
command = ${deployment:bin-directory}/backupdb -c ${deployment:etc-directory}/db-backup-config.json --temp-dir ${backupvars:backup_cache_dir} --backup-dir ${backupvars:db_backup_dir} -e showcase

[logfetch-alpha]
recipe = z3c.recipe.usercrontab
times = 0 6 * * *
command = ${deployment:bin-directory}/logfetch -c ${deployment:etc-directory}/logfetch-config.json --backup-dir ${backupvars:log_backup_dir} -e alpha

[logfetch-janux]
recipe = z3c.recipe.usercrontab
times = 0 6 * * *
command = ${deployment:bin-directory}/logfetch -c ${deployment:etc-directory}/logfetch-config.json --backup-dir ${backupvars:log_backup_dir} -e janux

[logfetch-mathcounts]
recipe = z3c.recipe.usercrontab
times = 0 6 * * *
command = ${deployment:bin-directory}/logfetch -c ${deployment:etc-directory}/logfetch-config.json --backup-dir ${backupvars:log_backup_dir} -e mathcounts

[logfetch-okstate]
recipe = z3c.recipe.usercrontab
times = 0 6 * * *
command = ${deployment:bin-directory}/logfetch -c ${deployment:etc-directory}/logfetch-config.json --backup-dir ${backupvars:log_backup_dir} -e okstate

[logfetch-outest]
recipe = z3c.recipe.usercrontab
times = 0 6 * * *
command = ${deployment:bin-directory}/logfetch -c ${deployment:etc-directory}/logfetch-config.json --backup-dir ${backupvars:log_backup_dir} -e outest

[logfetch-prod]
recipe = z3c.recipe.usercrontab
times = 0 6 * * *
command = ${deployment:bin-directory}/logfetch -c ${deployment:etc-directory}/logfetch-config.json --backup-dir ${backupvars:log_backup_dir} -e prod

[logfetch-showcase]
recipe = z3c.recipe.usercrontab
times = 0 6 * * *
command = ${deployment:bin-directory}/logfetch -c ${deployment:etc-directory}/logfetch-config.json --backup-dir ${backupvars:log_backup_dir} -e showcase

[gc_logs]
recipe = z3c.recipe.usercrontab
times = 0 23 * * *
command = ${deployment:bin-directory}/gc_logs

[supervisor]
# Disable supervisord based log rotation because we have switched to using logrotate
logfile-maxbytes = 0
childstdout-logfile-maxbytes = 0
childstderr-logfile-maxbytes = 0
# Don't wipe away existing logs
nocleanup = True
programs =
    1 alpha-aux1-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:aux1-address} ${backupvars:alpha_db_port} ${backupvars:alpha_binlogs_dir}/${backupvars:aux1}/]
    1 janux-db1-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:db1-address} ${backupvars:janux_db_port} ${backupvars:janux_binlogs_dir}/${backupvars:db1}/]
    1 janux-db2-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:db2-address} ${backupvars:janux_db_port} ${backupvars:janux_binlogs_dir}/${backupvars:db2}/]
    1 mathcounts-db3-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:db3-address} ${backupvars:mathcounts_db_port} ${backupvars:mathcounts_binlogs_dir}/${backupvars:db3}/]
    1 mathcounts-db4-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:db4-address} ${backupvars:mathcounts_db_port} ${backupvars:mathcounts_binlogs_dir}/${backupvars:db4}/]
    1 outest-aux1-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:aux1-address} ${backupvars:outest_db_port} ${backupvars:outest_binlogs_dir}/${backupvars:aux1}/]
    1 okstate-db3-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:db3-address} ${backupvars:okstate_db_port} ${backupvars:okstate_binlogs_dir}/${backupvars:db3}/]
    1 okstate-db4-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:db4-address} ${backupvars:okstate_db_port} ${backupvars:okstate_binlogs_dir}/${backupvars:db4}/]
    1 prod-db3-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:db3-address} ${backupvars:prod_db_port} ${backupvars:prod_binlogs_dir}/${backupvars:db3}/]
    1 prod-db4-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:db4-address} ${backupvars:prod_db_port} ${backupvars:prod_binlogs_dir}/${backupvars:db4}/]
    1 showcase-db4-mysql-binlog ${deployment:bin-directory}/get_binary_logs [${deployment:etc-directory}/mysql/my-client.cnf ${backupvars:db4-address} ${backupvars:showcase_db_port} ${backupvars:showcase_binlogs_dir}/${backupvars:db4}/]

alpha_group_programs = alpha-aux1-mysql-binlog
janux_group_programs = janux-db1-mysql-binlog,janux-db2-mysql-binlog
mathcounts_group_programs = mathcounts-db3-mysql-binlog,mathcounts-db4-mysql-binlog
okstate_group_programs = okstate-db3-mysql-binlog,okstate-db4-mysql-binlog
outest_group_programs = outest-aux1-mysql-binlog
prod_group_programs = prod-db3-mysql-binlog,prod-db4-mysql-binlog
showcase_group_programs = showcase-db4-mysql-binlog

groups =
    999 alpha ${:alpha_group_programs}
    999 janux ${:janux_group_programs}
    999 mathcounts ${:mathcounts_group_programs}
    999 okstate ${:okstate_group_programs}
    999 outest ${:outest_group_programs}
    999 prod ${:prod_group_programs}
    999 showcase ${:showcase_group_programs}
