[buildout]
extends =
		haproxy.cfg
		nginx.cfg
       	base_environment.cfg
parts +=
      zlib
	  openssl
	  haproxy
	  nginx
	  ssl-cert

[ssl-cert]
recipe = collective.recipe.cmd
on_install = true
on_update = false
cmds =
    echo "Creating SSL key and 10 year self-signed Cert"
    echo "----------------------------------"
    mkdir -p ${deployment:etc-directory}/certs
    ${deployment:root-directory}/parts/openssl/bin/openssl genrsa -out ${deployment:etc-directory}/certs/localhost.key 2048
    ${deployment:root-directory}/parts/openssl/bin/openssl req -batch -sha256 -new -key ${deployment:etc-directory}/certs/localhost.key -out ${deployment:etc-directory}/certs/localhost.csr -subj "/C=US/ST=Oklahoma/O=NextThought/CN=localhost"
    ${deployment:root-directory}/parts/openssl/bin/openssl x509 -req -sha256 -days 3650 -in ${deployment:etc-directory}/certs/localhost.csr -signkey ${deployment:etc-directory}/certs/localhost.key -out ${deployment:etc-directory}/certs/localhost.crt
    cat ${deployment:etc-directory}/certs/localhost.key  ${deployment:etc-directory}/certs/localhost.crt > ${environment-haproxy:ssl_cert}
    rm ${deployment:etc-directory}/certs/localhost.csr ${deployment:etc-directory}/certs/localhost.crt ${deployment:etc-directory}/certs/localhost.key
