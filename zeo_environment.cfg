[buildout]
extends = base_environment.cfg
parts +=
	  zeo_dirs
	  zeo
	  supervisor
	  zodb_conf
	  zodb_uri_conf

[zeo_dirs]
recipe = z3c.recipe.mkdir
paths = data/data.fs.blobs
mode = 0700

[zeo]
name = Dataserver
recipe = zc.zodbrecipes:server
clientPipe = ${buildout:directory}/var/zeosocket
dataFile = ${buildout:directory}/data/data.fs
logFile = ${buildout:directory}/var/log/zeo.log
blobDir = ${zeo_dirs:paths}
zeo.conf =
		%import zc.zlibstorage
		<zeo>
			address ${:clientPipe}
		</zeo>
		<serverzlibstorage>
			<filestorage 1>
				path ${:dataFile}
				blob-dir ${:blobDir}
				pack-gc false
			</filestorage>
		</serverzlibstorage>

		<eventlog>
			<logfile>
				path ${:logFile}
				format %%(asctime)s %%(message)s
				level DEBUG
			</logfile>
		</eventlog>
deployment = deployment

[supervisor]
programs +=
		 1 zeo ${deployment:etc-directory}/bin/zeo [${deployment:etc-directory}/${zeo:name}-zeo.conf]

[zodb_conf]
recipe = collective.recipe.template
output = ${deployment:etc-directory}/zodb_conf.xml
input = inline:
		%import zc.zlibstorage

		<zodb Users>
			pool-size 2
			database-name Users
			cache-size 75000
			<zlibstorage>
				<zeoclient>
					server ${zeo:clientPipe}
					shared-blob-dir True
					blob-dir ${zeo:blobDir}
					storage 1
					name Users
				</zeoclient>
			</zlibstorage>
		</zodb>

[zodb_uri_conf]
recipe = collective.recipe.template
output = ${deployment:etc-directory}/zeo_uris.ini
input = inline:
	  [ZODB]
	  uris = zconfig://${zodb_conf:output}#users
