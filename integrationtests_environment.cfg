# A buildout for setting up and running
# integration test suite.
[buildout]
extends =
		sphinxdoc.cfg
		zeo_environment.cfg
		analytics.cfg
		ims.cfg
		badges.cfg
		oubound.cfg
		analytics_pandas.cfg
		contentrendering.cfg
		courseware_content.cfg

relative-paths = false

parts -=
	  omelette
	  redis
	  python_ldap
	  openssl
	  haproxy
	  nginx
	  nginx-conf
	  memcached
	  imagemagick
	  libjpeg
	  libpng
	  pillow
	  pycrypto
	  libgmp
parts +=
	  phantomjs
	  z3c_sphinxdoc
# Somewhat often we hit the threading bug that
# locks the system up during integration testing,
# preventing it from running. Also, all the simultaneous
# checkouts sometimes make our SVN server complain...
# UPDATE: Hold off on that, we just seem to have a really
# terrible Internet connection while testing this
# mr.developer-threads = 1

[courseware-ALL-sources]
<= courseware-content-ALL-sources

[site-sources]
<= site-ALL-sources

[product-sources]
<= product-ALL-sources

[extra-sources]
nti.app.testing = svn https://repos.nextthought.com/svn/nti-svn/nti.app.testing/trunk
nti.integrationtests = svn https://repos.nextthought.com/svn/nti-svn/nti.integrationtests/trunk

[financial-plan-sources]
nti.oubound.financialplan = git git@github.com:NextThought/nti.oubound.financialplan.git ${oubound-versions:financialplan}
nti.app.oubound.financialplan = git git@github.com:NextThought/nti.app.oubound.financialplan.git ${oubound-versions:financialplan}

[housing-sources]
nti.oubound.housing = git git@github.com:NextThought/nti.oubound.housing.git ${oubound-versions:housing}
nti.app.oubound.housing = git git@github.com:NextThought/nti.app.oubound.housing.git ${oubound-versions:housing}

[scholarship-sources]
nti.oubound.scholarship = git git@github.com:NextThought/nti.oubound.scholarship.git ${oubound-versions:scholarship}
nti.app.oubound.scholarship = git git@github.com:NextThought/nti.app.oubound.scholarship.git ${oubound-versions:scholarship}

[oubound-common-sources]
nti.oubound.common = git git@github.com:NextThought/nti.oubound.common.git ${oubound-versions:common}
nti.app.oubound.common = git git@github.com:NextThought/nti.app.oubound.common.git ${oubound-versions:common}

[oubound-sources]
<=  oubound-common-sources
    scholarship-sources
    housing-sources
    financial-plan-sources
    timeline-sources
	analytics-pandas-sources

[eggs]
dataserver_egg = nti.dataserver[tools,test]
eggs +=
	 tox
	 ${site-ALL-eggs:eggs}
	 ${product-ALL-eggs:eggs}
	 ${analytics-ALL-eggs:eggs}
	 ${badges-ALL-eggs:eggs}
	 nti.recipes.zcml
	 nti.integrationtests
	 z3c.recipe.sphinxdoc
	 nose2
	 nose2-cov
	 zope.testrunner
	 ${oubound-ALL-eggs:eggs}
	 ${courseware-content-ALL-eggs:eggs}
	 ${contentrendering-MAIN-eggs:eggs}
	 ${analytics-pandas-ALL-eggs:eggs}

initialization +=
			   os.environ['PATH'] = "${deployment:root-directory}/parts/phantomjs/bin" + os.pathsep + os.environ['PATH']

# We would like to pick up some of the things
# from contentrendering.cfg, notably phantomjs;
# but if we try, we also recompile imagemagick every
# time, which is far too slow. I didn't find a way to factor
# out initialization and part code such that it could
# be made to happen; therefore, we have our own copy.
# The test machine must supply its own install of
# imagemagick and latex.

[phantomjs]
recipe = hexagonit.recipe.download
url = https://s3.amazonaws.com/dev.nextthought.com/phantomjs-2.0.0-development-macosx-201501031642.zip
strip-top-level-dir = true
excludes =
         examples
         README.md
         third-party.txt

[deployment]
root-directory = ${buildout:root-directory}

[environment]
global_content_directory = /Library/WebServer/Documents

[pserve-conf]
http-port = 62543
use_devmode = 1
secure_cookies = 0

[gunicorn-conf]
# Use a controlled number of workers rather than
# auto-calc for ease of debugging and reproduction.
# But use more than one to test concurrency
workers = 2

[init_env]
args = --with-example

[redis-conf]
redis-path = /opt/local/bin/redis-server

[zcml]
package_features +=
				 devmode
				 testmode

[supervisor]
# Turn off email of crashes
eventlisteners =

[webapp-conf]
files = 999-nti.app.i18n.zcml

