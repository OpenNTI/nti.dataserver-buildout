global
    log         127.0.0.1 daemon warning 
    maxconn     ${haproxy_maxconn} # Total Max Connections. This is dependent on ulimit

    stats socket ${haproxy_stats_socket} mode 600 level admin
    stats timeout 2m

defaults
    timeout queue 5s
    timeout server 5m
    timeout client 60s
    timeout connect 60s
    # Force websocket connections to move to a different
    # worker every so ofter. This overrides client/server
    # timeout
    timeout tunnel 10m
    errorfile 408 /dev/null

frontend all
    mode http
    log global
    timeout client 86400000
    option httplog
    # Listen on the socket for incoming SSL in proxy mode
    # We give it a specific id so that we can match in an ACL
    # (We can't match on ssl itself because that's already been handled)
    ${haproxy_listen_ports}

    ${haproxy_hostname_backend_map}

    # Our stunnel socket is always SSL
    ${haproxy_ssl_acls}

    ${haproxy_extra_config}

    # Let gunicorn/nginx know if we are dealing with an incoming HTTPS request
    # (This is a default 'secure-header' in gunicorns conf)
    reqidel ^X-FORWARDED-PROTOCOL:.*
    reqadd X-FORWARDED-PROTOCOL:\ ssl if is_ssl

    ${haproxy_extra_redirects}

    use_backend app_backend0 if is_backend0
    use_backend app_backend1 if is_backend1
    use_backend app_backend2 if is_backend2
    use_backend app_backend3 if is_backend3
    use_backend app_backend4 if is_backend4
    use_backend app_backend5 if is_backend5
    use_backend app_backend6 if is_backend6
    use_backend app_backend6 if is_backend7
    use_backend app_backend8 if is_backend8

# Old Prod
backend app_backend0
    mode http
    balance source
    option forwardfor # This sets X-Forwarded-For
    option http-server-close
    ${haproxy_app_backend0}

# MATHCOUNTS
backend app_backend1
    mode http
    balance source
    option forwardfor # This sets X-Forwarded-For
    option http-server-close
    ${haproxy_app_backend1}

# Alpha
backend app_backend2
    mode http
    balance source
    option forwardfor # This sets X-Forwarded-For
    option http-server-close
    ${haproxy_app_backend2}

# Janux
backend app_backend3
    mode http
    balance source
    option forwardfor # This sets X-Forwarded-For
    option http-server-close
    ${haproxy_app_backend3}

# OU-Test
backend app_backend4
    mode http
    balance source
    option forwardfor # This sets X-Forwarded-For
    option http-server-close
    ${haproxy_app_backend4}

# Content Dev
backend app_backend5
    mode http
    balance source
    option forwardfor # This sets X-Forwarded-For
    option http-server-close
    ${haproxy_app_backend5}

# Wiley
backend app_backend6
    mode http
    balance source
    option forwardfor # This sets X-Forwarded-For
    option http-server-close
    ${haproxy_app_backend6}

# CCMF
backend app_backend7
    mode http
    balance source
    option forwardfor # This sets X-Forwarded-For
    option http-server-close
    ${haproxy_app_backend7}

# Performance Testing
backend app_backend8
    mode http
    balance source
    option forwardfor # This sets X-Forwarded-For
    option http-server-close
    ${haproxy_app_backend8}

